<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
<meta charset="UTF-8">
<title>√Årea da Escola</title>

<style>

.lista-alunos {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 4px;
}

.aluno-tag {
  background: rgba(0,0,0,0.15);
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 11px;
  color: #000;
}


.aluno-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-weight: bold;
}

.seta {
    width: 0;
    height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 8px solid #111;
    transition: transform 0.3s ease;
}

/* aberto ‚Üí seta para baixo */
.aluno-header.aberto .seta {
    transform: rotate(90deg);
}

.boletos {
    display: none;
    margin-top: 15px;
}

body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f1f5f9;
}
header {
    background: linear-gradient(90deg, #7f1d1d, #991b1b);
    color: white;
    padding: 24px;
}
.container {
    display: flex;
    min-height: calc(100vh - 88px);
}
.menu {
    width: 260px;
    background: white;
    border-right: 1px solid #e5e7eb;
    padding: 20px;
}
.menu button {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    border: none;
    background: #f1f5f9;
    cursor: pointer;
    text-align: left;
    border-radius: 8px;
    transition: .25s;
}
.menu button:hover {
    background: #fee2e2;
    transform: translateX(6px);
}
.content {
  flex: 1;
  padding: 30px;
  background: #f8fafc;
}

#horarios .card {
  overflow: hidden;
}

.section { display: none; }
.section.active { display: block; }
.card, .level {
    background: white;
    padding: 22px;
    border-radius: 14px;
    margin-bottom: 24px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.06);
}
input, select, textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
}
button.primary {
    background: #991b1b;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
}
button.edit {
    background: #2563eb;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
button.delete {
    background: #dc2626;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 10px;
    border: 1px solid #e5e7eb;
}
tr.basico { background: #eff6ff; }
tr.intermediario { background: #ecfdf5; }
tr.avancado { background: #fef2f2; }

/* ================= RESPONSIVO ================= */
  @media (max-width: 768px) {

    .container {
      flex-direction: column;
      height: auto;
    }

    .menu {
      width: 100%;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 10px;
    }

    .menu button {
      flex: 1;
      white-space: nowrap;
      font-size: 14px;
      padding: 10px;
    }

    table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }

    input, select, textarea, button {
      font-size: 16px;
    }

    button {
      padding: 14px;
    }

    .card {
      padding: 16px;
      margin-bottom: 16px;
    }

    .aluno-header {
      font-size: 16px;
    }
  }

.horarios-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.horario-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.06);
}

.horario-card h4 {
  margin-bottom: 10px;
}

.calendario-semana {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  margin-top: 16px;
}

.dia-coluna {
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.06);
}

.dia-coluna h4 {
  text-align: center;
  margin-bottom: 8px;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 6px;
}

.aula {
  background: #fee2e2;
  border-radius: 8px;
  padding: 6px;
  margin-bottom: 6px;
  font-size: 13px;
}

.calendario-grade {
  display: grid;
  grid-template-columns: 80px repeat(5, 1fr);
  border: 1px solid #e5e7eb;
}

.cabecalho {
  background: #f1f5f9;
  font-weight: bold;
  text-align: center;
  padding: 8px;
  border: 1px solid #e5e7eb;
}

.hora {
  background: #f8fafc;
  font-weight: bold;
  text-align: center;
  border: 1px solid #e5e7eb;
}

.celula {
  position: relative;
  border: 1px solid #e5e7eb;
  min-height: 60px;
}

.aula-grade {
  padding: 6px;
  border-radius: 8px;
  font-size: 12px;
  overflow: hidden;
  word-break: break-word;
}


</style>
</head>

<body>

<header>
<h1>√Årea da Escola</h1>
<p>Gest√£o Acad√™mica</p>
</header>

<div class="container">

<div class="menu">
    <button onclick="mostrar('inicio')">üè† In√≠cio</button>
    <button onclick="mostrar('alunos')">üë©‚Äçüéì Alunos</button>
    <button onclick="mostrar('pagamentos')">üí∞ Pagamentos</button>
    <button onclick="mostrar('tarefas')">üìù Tarefas</button>
    <button onclick="mostrar('projetos')">üìÅ Projetos Externos</button>
    <button onclick="mostrar('calendario')">üìÖ Calend√°rio</button>
    <button onclick="mostrar('horarios')">üïí Hor√°rios</button>
</div>


<div class="content">

  <!-- ================= IN√çCIO ================= -->
  <div id="inicio" class="section active">
    <div class="card">
      <h2>Bem-vindo!</h2>
      <p>Gerencie toda a plataforma educacional.</p>
    </div>
  </div>

  <!-- ================= ALUNOS ================= -->
  <div id="alunos" class="section">
    <div class="card">
      <h2>Cadastrar / Editar Aluno</h2>

      <input id="alunoNome" placeholder="Nome completo">
      <input id="alunoCpf" placeholder="CPF">

      <select id="alunoNivel">
        <option value="">Selecione o n√≠vel</option>
        <option value="basico">B√°sico</option>
        <option value="intermediario">Intermedi√°rio</option>
        <option value="avancado">Avan√ßado</option>
      </select>

      <button class="primary" onclick="salvarAluno()">Salvar aluno</button>
    </div>

    <div class="card">
      <h2>Alunos cadastrados</h2>
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>CPF</th>
            <th>N√≠vel</th>
            <th>Login</th>
            <th>Senha</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaAlunos"></tbody>
      </table>
    </div>
  </div>

  <!-- ================= PAGAMENTOS ================= -->
  <div id="pagamentos" class="section">
    <div class="card">
      <h2>Boletos por aluno</h2>
      <div id="listaBoletosPorAluno"></div>
    </div>
  </div>

  <!-- ================= TAREFAS ================= -->
  <div id="tarefas" class="section">
    <div class="card">
      <h2>Adicionar tarefa</h2>

      <input id="unidadeTarefa" placeholder="Nome da unidade">
      <input id="nomeTarefa" placeholder="Nome da tarefa">

      <select id="nivelTarefa">
        <option value="">N√≠vel</option>
        <option value="basico">B√°sico</option>
        <option value="intermediario">Intermedi√°rio</option>
        <option value="avancado">Avan√ßado</option>
      </select>

      <input 
  type="file" 
  id="arquivoTarefa"
  accept=".pdf,.doc,.docx"
>
      <button class="primary" onclick="addTarefa()">Salvar tarefa</button>
    </div>

    <div id="listaTarefasAdmin"></div>
  </div>

  <!-- ================= PROJETOS ================= -->
  <div id="projetos" class="section">
    <div class="card">
      <h2>Adicionar projeto externo</h2>

      <select id="nivelProjeto">
        <option value="">Selecione o n√≠vel</option>
        <option value="basico">B√°sico</option>
        <option value="intermediario">Intermedi√°rio</option>
        <option value="avancado">Avan√ßado</option>
      </select>

      <input id="nomeProjeto" placeholder="Nome do projeto">
      <textarea id="descProjeto" placeholder="Descri√ß√£o do projeto"></textarea>
      <input 
  type="file" 
  id="arquivoProjeto"
  accept=".pdf,.doc,.docx"
>

      <button class="primary" onclick="salvarProjeto()">Salvar projeto</button>
    </div>

    <div id="listaProjetos"></div>
  </div>

  <!-- ================= CALEND√ÅRIO ================= -->
  <div id="calendario" class="section">
    <div class="card">
      <button class="primary" onclick="adicionarMes()">‚ûï Pr√≥ximo m√™s</button>
    </div>
    <div id="listaMeses"></div>
  </div>

  <!-- ================= HOR√ÅRIOS (AGORA CERTO) ================= -->
  <div id="horarios" class="section">

    <div class="card">
      <h2>Cadastro de Hor√°rio</h2>

      <select id="alunoHorario"></select>

      <select id="tipoAula">
        <option value="">Tipo de aula</option>
        <option value="particular">Particular</option>
        <option value="turma">Turma</option>
      </select>

      <select id="qtdAulas" onchange="gerarHorarios()">
        <option value="">Vezes por semana</option>
        <option value="1">1x</option>
        <option value="2">2x</option>
        <option value="3">3x</option>
        <option value="4">4x</option>
      </select>

      <div id="horariosSemana"></div>

      <button class="primary" onclick="salvarHorario()">Salvar hor√°rios</button>
    </div>

    <div class="card">
      <h2>Hor√°rios cadastrados</h2>
      <div id="listaHorarios"></div>
    </div>

  </div>

</div>


<script type="module">



import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword,
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  getDoc,
  setDoc,          // üëà FALTAVA ISSO
  doc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "speaking-loud.firebaseapp.com",
  projectId: "speaking-loud",
  storageBucket: "speaking-loud.firebasestorage.app",
  messagingSenderId: "1002979647448",
  appId: "1:1002979647448:web:6dc375319cd8ac3aeadcad"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// üîí BLOQUEIO ABSOLUTO
/* ================= AUTH - ESCOLA ================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "../index.html";
    return;
  }

  const uid = user.uid;
  const snap = await getDoc(doc(db, "usuarios", uid));

  if (!snap.exists() || snap.data().tipo !== "escola") {
    window.location.href = "../index.html";
    return;
  }

  // ‚úÖ secret√°rio autorizado
});
// ================= DOM =================
const listaAlunos = document.getElementById("listaAlunos");

const listaTarefasAdmin = document.getElementById("listaTarefasAdmin");
const listaProjetos = document.getElementById("listaProjetos");
const listaMeses = document.getElementById("listaMeses");

const unidadeTarefa = document.getElementById("unidadeTarefa");
const nomeTarefa = document.getElementById("nomeTarefa");
const nivelTarefa = document.getElementById("nivelTarefa");
const arquivoTarefa = document.getElementById("arquivoTarefa");

const nivelProjeto = document.getElementById("nivelProjeto");
const nomeProjeto = document.getElementById("nomeProjeto");
const descProjeto = document.getElementById("descProjeto");
const arquivoProjeto = document.getElementById("arquivoProjeto");

const listaBoletosPorAluno = document.getElementById("listaBoletosPorAluno");

let secondaryAuth;
let alunoEditandoId = null;

try {
  const secondaryApp = initializeApp(firebaseConfig, "SecondaryAluno");
  secondaryAuth = getAuth(secondaryApp);
} catch (e) {
  secondaryAuth = getAuth(getApps().find(app => app.name === "SecondaryAluno"));
}

/* ================= RENDER ALUNOS ================= */
async function renderAlunosFirestore() {
    listaAlunos.innerHTML = "";

    const snapshot = await getDocs(collection(db, "alunos"));

    snapshot.forEach((docSnap) => {
        const a = docSnap.data();
        const id = docSnap.id;

        listaAlunos.innerHTML += `
        <tr class="${(a.nivel || "").toLowerCase()}">
            <td>${a.nome}</td>
            <td>${a.cpf || "-"}</td>
            <td>${a.nivel}</td>
            <td>${a.login}</td>
            <td>${a.senha || "‚Äî"}</td>
            <td>
                <button class="edit"
                    onclick="editarAluno('${id}', '${a.nome}', '${a.cpf}', '${a.nivel}')">
                    Editar
                </button>
                <button class="delete"
                    onclick="excluirAluno('${id}', '${a.nome}')">
                    Excluir
                </button>
            </td>
        </tr>`;
    });
}

function horaParaMinutos(h) {
  const [hh, mm] = h.split(":").map(Number);
  return hh * 60 + mm;
}

function gerarLogin(nome) {
    return nome
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z ]/g, "")
        .trim()
        .split(" ")
        .slice(0, 2)
        .join(".");
}

function gerarSenha() {
    return Math.random().toString(36).slice(-8);
}


/* SALVAR ALUNO ‚Äî FIRESTORE */
window.salvarAluno = async function () {
  const nomeInput = document.getElementById("alunoNome");
  const cpfInput = document.getElementById("alunoCpf");
  const nivelInput = document.getElementById("alunoNivel");

  // ‚úèÔ∏è EDITAR ALUNO
  if (alunoEditandoId) {
    try {
      await updateDoc(doc(db, "alunos", alunoEditandoId), {
        nome: nomeInput.value,
        cpf: cpfInput.value,
        nivel: nivelInput.value
      });

      alert("Aluno atualizado com sucesso!");

      alunoEditandoId = null;
      nomeInput.value = "";
      cpfInput.value = "";
      nivelInput.value = "";

      renderAlunosFirestore();
      return;
    } catch (e) {
      console.error(e);
      alert("Erro ao editar aluno");
      return;
    }
  }


  const loginAluno = gerarLogin(nomeInput.value);
  const senhaAluno = gerarSenha();
  const emailFirebase = loginAluno + "@speakingloud.com";

  try {

    // ‚úÖ CRIA USU√ÅRIO NO AUTH
    const cred = await createUserWithEmailAndPassword(
  secondaryAuth,
  emailFirebase,
  senhaAluno
);

// üî• RESETA CONTEXTO PARA ESCOLA
const emailEscola = auth.currentUser.email;
const uidAluno = cred.user.uid;

    // ‚úÖ SALVA NO FIRESTORE
await addDoc(collection(db, "alunos"), {
  nome: nomeInput.value,
  cpf: cpfInput.value,
  nivel: nivelInput.value,
  login: loginAluno,
  senha: senhaAluno,
  criadoEm: new Date()
});

// ‚úÖ SALVA NA COLE√á√ÉO "usuarios" (PERMISS√ÉO)
await setDoc(doc(db, "usuarios", uidAluno), {
  tipo: "aluno",
  login: loginAluno,
  criadoEm: new Date()
});

    alert(
      `Aluno criado com sucesso!\n\nLogin: ${loginAluno}\nSenha: ${senhaAluno}`
    );

    nomeInput.value = "";
    cpfInput.value = "";
    nivelInput.value = "";

    renderAlunosFirestore();

  } catch (error) {
    console.error("ERRO AO CRIAR ALUNO:", error);
    alert(error.message);
  }
};

/* ================= PAGAMENTOS ================= */
/* ================= RENDER BOLETOS ================= */
async function renderBoletosPorAluno() {
  listaBoletosPorAluno.innerHTML = "";

  const alunosSnap = await getDocs(collection(db, "alunos"));
  const boletosSnap = await getDocs(collection(db, "boletos"));

  const boletosPorAluno = {};

  boletosSnap.forEach(docSnap => {
    const b = docSnap.data();
    if (!boletosPorAluno[b.alunoLogin]) {
      boletosPorAluno[b.alunoLogin] = [];
    }
    boletosPorAluno[b.alunoLogin].push({ ...b, id: docSnap.id });
  });

  alunosSnap.forEach(alunoDoc => {
    const aluno = alunoDoc.data();
    const login = aluno.login;

    const boletos = boletosPorAluno[login] || [];

    const boxId = `boletos-${login}`;

    listaBoletosPorAluno.innerHTML += `
      <div class="card">
        <div class="aluno-header" onclick="toggleBoletos('${boxId}', this)">
          ${aluno.nome} (${login})
          <span class="seta"></span>
        </div>

        <div class="boletos" id="${boxId}">
          <div style="margin:15px 0">
            <input placeholder="M√™s do boleto" id="mes-${login}">
            <input type="date" id="venc-${login}">
            <input placeholder="PIX" id="pix-${login}">
            <input 
            type="file" 
            id="file-${login}"
            accept=".pdf,.doc,.docx"
            >
            <button class="primary" onclick="salvarBoletoAluno('${login}')">
              ‚ûï Adicionar boleto
            </button>
          </div>

${
  boletos.length === 0
    ? "<p>Nenhum boleto cadastrado.</p>"
    : boletos.map(b => `
      <div style="border-top:1px solid #e5e7eb;padding-top:10px;margin-top:10px">
        <strong>${b.mes}</strong><br>
        Vencimento: ${b.vencimento}<br>

        <p>
          Status:
          <strong style="color:${b.status === "pago" ? "green" : "red"}">
            ${b.status === "pago" ? "PAGO" : "PENDENTE"}
          </strong>
        </p>

        <a href="${b.arquivo}" download>üìÑ Baixar</a><br><br>

        ${
          b.status !== "pago"
            ? `<button class="edit" onclick="marcarBoletoComoPago('${b.id}')">
                 ‚úÖ Marcar como pago
               </button>`
            : ""
        }

        <button class="delete" onclick="excluirBoleto('${b.id}')">
          üóëÔ∏è Excluir
        </button>
      </div>
    `).join("")
}

        </div>
      </div>
    `;
  });
}

window.marcarBoletoComoPago = async function (id) {
  const ok = confirm("Deseja marcar este boleto como PAGO?");
  if (!ok) return;

  try {
    await updateDoc(doc(db, "boletos", id), {
      status: "pago"
    });

    alert("Boleto marcado como PAGO!");
    renderBoletosPorAluno();
  } catch (e) {
    console.error(e);
    alert("Erro ao marcar boleto como pago");
  }
};


window.excluirBoleto = async function (id) {
  const ok = confirm("Deseja excluir este boleto?");
  if (!ok) return;

  try {
    await deleteDoc(doc(db, "boletos", id));
    alert("Boleto exclu√≠do com sucesso!");
    renderBoletosPorAluno();
  } catch (e) {
    console.error(e);
    alert("Erro ao excluir boleto");
  }
};

window.salvarBoletoAluno = async function (login) {
  try {
    if (!auth.currentUser) {
      alert("Sess√£o expirada. Recarregue a p√°gina.");
      return;
    }

    const mesInput = document.getElementById(`mes-${login}`);
    const vencInput = document.getElementById(`venc-${login}`);
    const pixInput = document.getElementById(`pix-${login}`);
    const fileInput = document.getElementById(`file-${login}`);

    if (!mesInput || !vencInput || !pixInput || !fileInput) {
      alert("Campos do boleto n√£o encontrados.");
      return;
    }

    const mes = mesInput.value.trim();
    const vencimento = vencInput.value;
    const pix = pixInput.value.trim();
    const file = fileInput.files[0];

    if (!mes || !vencimento || !pix || !file) {
      alert("Preencha todos os campos do boleto.");
      return;
    }

    console.log("‚¨ÜÔ∏è Enviando boleto:", { login, mes, vencimento });

    const storageRef = ref(
      storage,
      `boletos/${login}/${Date.now()}-${file.name}`
    );

    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);

    await addDoc(collection(db, "boletos"), {
      alunoLogin: login,
      mes,
      vencimento,
      pix,
      arquivo: url,
      status: "pendente",
      criadoEm: new Date()
    });

    alert("‚úÖ Boleto salvo com sucesso!");
    renderBoletosPorAluno();

  } catch (e) {
    console.error("‚ùå ERRO AO SALVAR BOLETO:", e);
    alert("Erro ao salvar boleto. Veja o console (F12).");
  }
};

/* ================= TAREFAS ‚Äî FIRESTORE ================= */

/* ADICIONAR TAREFA */
window.addTarefa = async function () {
  try {
    const unidadeInput = document.getElementById("unidadeTarefa");
    const nomeInput = document.getElementById("nomeTarefa");
    const nivelInput = document.getElementById("nivelTarefa");
    const fileInput = document.getElementById("arquivoTarefa");

    if (!unidadeInput || !nomeInput || !nivelInput || !fileInput) {
      alert("Campos da tarefa n√£o encontrados.");
      return;
    }

    const unidade = unidadeInput.value.trim();
    const nome = nomeInput.value.trim();
    const nivel = nivelInput.value;
    const file = fileInput.files[0];

    if (!unidade || !nome || !nivel || !file) {
      alert("Preencha todos os campos da tarefa.");
      return;
    }

    console.log("‚¨ÜÔ∏è Enviando tarefa:", { unidade, nome, nivel });

    const storageRef = ref(
      storage,
      `tarefas/${nivel}/${Date.now()}-${file.name}`
    );

    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);

    await addDoc(collection(db, "tarefas"), {
      unidade,
      nome,
      nivel,
      arquivo: url,
      criadoEm: new Date()
    });

    unidadeInput.value = "";
    nomeInput.value = "";
    nivelInput.value = "";
    fileInput.value = "";

    alert("‚úÖ Tarefa salva com sucesso!");
    renderTarefasFirestore();

  } catch (e) {
    console.error("‚ùå ERRO AO SALVAR TAREFA:", e);
    alert("Erro ao salvar tarefa. Veja o console (F12).");
  }
};
/* RENDERIZAR TAREFAS */
async function renderTarefasFirestore(){
  listaTarefasAdmin.innerHTML = "";

  const snapshot = await getDocs(collection(db, "tarefas"));

  const tarefasPorNivel = {
    basico: [],
    intermediario: [],
    avancado: []
  };

  snapshot.forEach(docSnap => {
    const t = docSnap.data();
    tarefasPorNivel[t.nivel].push({ ...t, id: docSnap.id });
  });

  const niveis = [
    { id: "basico", nome: "üîµ B√°sico" },
    { id: "intermediario", nome: "üü¢ Intermedi√°rio" },
    { id: "avancado", nome: "üî¥ Avan√ßado" }
  ];

  niveis.forEach((n, index) => {
    const lista = tarefasPorNivel[n.id];
    const id = `tarefas-${index}`;

    listaTarefasAdmin.innerHTML += `
      <div class="card">
        <div class="aluno-header" onclick="toggleBoletos('${id}', this)">
          ${n.nome}
          <span class="seta"></span>
        </div>

        <div class="boletos" id="${id}">
          ${
            lista.length === 0
              ? "<p>Nenhuma tarefa cadastrada.</p>"
              : lista.map(t => `
  <div style="border-top:1px solid #e5e7eb; padding-top:10px; margin-top:10px">
    <strong>${t.unidade}</strong><br>
    ${t.nome}<br>
<a href="${t.arquivo}" download>üìÑ Baixar</a><br><br>
    <button class="delete"
      onclick="excluirTarefa('${t.id}')">
      üóëÔ∏è Excluir tarefa
    </button>
  </div>
`).join("")
          }
        </div>
      </div>
    `;
  });
}

window.excluirTarefa = async function (id) {
  const ok = confirm("Deseja excluir esta tarefa?");

  if (!ok) return;

  try {
    await deleteDoc(doc(db, "tarefas", id));
    alert("Tarefa exclu√≠da com sucesso!");
    renderTarefasFirestore();
  } catch (e) {
    console.error(e);
    alert("Erro ao excluir tarefa");
  }
};


/* ================= PROJETOS ‚Äî FIRESTORE ================= */

window.salvarProjeto = async function () {
  try {
    const nivelInput = document.getElementById("nivelProjeto");
    const nomeInput = document.getElementById("nomeProjeto");
    const descInput = document.getElementById("descProjeto");
    const fileInput = document.getElementById("arquivoProjeto");

    if (!nivelInput || !nomeInput || !descInput || !fileInput) {
      alert("Campos do projeto n√£o encontrados.");
      return;
    }

    const nivel = nivelInput.value;
    const nome = nomeInput.value.trim();
    const desc = descInput.value.trim();
    const file = fileInput.files[0];

    if (!nivel || !nome || !desc || !file) {
      alert("Preencha todos os campos do projeto.");
      return;
    }

    console.log("‚¨ÜÔ∏è Enviando projeto:", { nome, nivel });

    const storageRef = ref(
      storage,
      `projetos/${nivel}/${Date.now()}-${file.name}`
    );

    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);

    await addDoc(collection(db, "projetos"), {
      nivel,
      nome,
      descricao: desc,
      arquivo: url,
      criadoEm: new Date()
    });

    nivelInput.value = "";
    nomeInput.value = "";
    descInput.value = "";
    fileInput.value = "";

    alert("‚úÖ Projeto salvo com sucesso!");
    renderProjetosFirestore();

  } catch (e) {
    console.error("‚ùå ERRO AO SALVAR PROJETO:", e);
    alert("Erro ao salvar projeto. Veja o console (F12).");
  }
};


async function renderProjetosFirestore(){
    listaProjetos.innerHTML = "";

    const snapshot = await getDocs(collection(db, "projetos"));

    const projetosPorNivel = {
        basico: [],
        intermediario: [],
        avancado: []
    };

    snapshot.forEach(doc => {
        const p = doc.data();
        projetosPorNivel[p.nivel].push(p);
    });

    const niveis = [
        { id: "basico", nome: "üîµ B√°sico" },
        { id: "intermediario", nome: "üü¢ Intermedi√°rio" },
        { id: "avancado", nome: "üî¥ Avan√ßado" }
    ];

    niveis.forEach((n, index) => {
        const lista = projetosPorNivel[n.id];
        const id = `projetos-${index}`;

        listaProjetos.innerHTML += `
        <div class="card">
            <div class="aluno-header" onclick="toggleBoletos('${id}', this)">
                ${n.nome}
                <span class="seta"></span>
            </div>

            <div class="boletos" id="${id}">
                ${
                    lista.length === 0
                    ? "<p>Nenhum projeto cadastrado.</p>"
                    : lista.map(p => `
                        <div style="border-top:1px solid #e5e7eb; padding-top:10px; margin-top:10px">
                            <strong>${p.nome}</strong><br><br>
                            ${p.descricao}<br><br>
                            <a href="${p.arquivo}" download>üìÑ Baixar documento</a>
                        </div>
                    `).join("")
                }
            </div>
        </div>`;
    });
}

window.toggleBoletos = function(id, el){
    const box = document.getElementById(id);
    const aberto = box.style.display === "block";

    box.style.display = aberto ? "none" : "block";
    el.classList.toggle("aberto", !aberto);
};


/* ================= CALEND√ÅRIO ‚Äî FIRESTORE ================= */

const meses = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

/* ADICIONAR M√äS */
window.adicionarMes = async function () {
    try {
        const snapshot = await getDocs(collection(db, "calendario"));
        let ultimoMes = null;

        snapshot.forEach(doc => {
            const d = doc.data();
            if (!ultimoMes || (d.ano > ultimoMes.ano || (d.ano === ultimoMes.ano && d.mes > ultimoMes.mes))) {
                ultimoMes = d;
            }
        });

        let mes = ultimoMes ? ultimoMes.mes + 1 : new Date().getMonth();
        let ano = ultimoMes ? ultimoMes.ano : new Date().getFullYear();

        if (mes > 11) {
            mes = 0;
            ano++;
        }

        await addDoc(collection(db, "calendario"), {
            mes,
            ano,
            imagem: null,
            criadoEm: new Date()
        });

        renderCalendarioFirestore();

    } catch (e) {
        console.error(e);
        alert("Erro ao adicionar m√™s");
    }
};

/* SALVAR IMAGEM */
window.salvarImg = async function (id, input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async () => {
        try {
            await updateDoc(doc(db, "calendario", id), {
                imagem: reader.result
            });
            renderCalendarioFirestore();
        } catch (e) {
            console.error(e);
            alert("Erro ao salvar imagem");
        }
    };
    reader.readAsDataURL(file);
};

/* RENDERIZAR */
async function renderCalendarioFirestore() {
    listaMeses.innerHTML = "";

    const snapshot = await getDocs(collection(db, "calendario"));

    const lista = [];
    snapshot.forEach(docu => {
        lista.push({ id: docu.id, ...docu.data() });
    });

    lista.sort((a, b) => a.ano === b.ano ? a.mes - b.mes : a.ano - b.ano);

    lista.forEach(m => {
        listaMeses.innerHTML += `
        <div class="card" style="text-align:center">
            <h1>${meses[m.mes]} ${m.ano}</h1>
            ${m.imagem ? `<img src="${m.imagem}" style="max-width:100%;border-radius:16px">` : ""}
            <input type="file" accept="image/*" onchange="salvarImg('${m.id}', this)">
        </div>`;
    });
}


/* ================= HOR√ÅRIOS ‚Äî FIRESTORE ================= */

const alunoHorario = document.getElementById("alunoHorario");
const tipoAula = document.getElementById("tipoAula");
const qtdAulas = document.getElementById("qtdAulas");
const horariosSemana = document.getElementById("horariosSemana");
const listaHorarios = document.getElementById("listaHorarios");

/* VERIFICA CONFLITO */
async function conflito(dia, inicio, fim, tipoAtual) {
  const snapshot = await getDocs(collection(db, "horarios"));

  const inicioMin = horaParaMinutos(inicio);
  const fimMin = horaParaMinutos(fim);

  for (const docSnap of snapshot.docs) {
    const h = docSnap.data();

    if (h.dia !== dia) continue;

    const hInicio = horaParaMinutos(h.inicio);
    const hFim = horaParaMinutos(h.fim);

    // n√£o sobrep√µe
    if (fimMin <= hInicio || inicioMin >= hFim) continue;

    // üîí REGRA DE OURO
    // PARTICULAR N√ÉO COMPARTILHA COM NINGU√âM
    if (h.tipo === "particular" || tipoAtual === "particular") {
      return true;
    }

    // turma com turma pode
  }

  return false;
}





/* SALVAR HOR√ÅRIO */
window.salvarHorario = async function () {
  const aluno = alunoHorario.value.trim();
  const tipo = tipoAula.value;

  const dias = document.querySelectorAll(".dia");
  const inicios = document.querySelectorAll(".inicio");
  const fins = document.querySelectorAll(".fim");

  if (!aluno || !tipo || dias.length === 0) {
    alert("Preencha todos os campos");
    return;
  }

  // üîç valida conflitos
for (let i = 0; i < dias.length; i++) {

  if (!dias[i].value || !inicios[i].value || !fins[i].value) {
    alert("Preencha todos os hor√°rios");
    return;
  }

  // ‚è∞ BLOQUEIA HOR√ÅRIOS ANTES DAS 08:00
  if (horaParaMinutos(inicios[i].value) < 480) {
    alert("Hor√°rios devem come√ßar a partir das 08:00");
    return;
  }

  if (horaParaMinutos(fins[i].value) <= horaParaMinutos(inicios[i].value)) {
    alert("O hor√°rio final deve ser maior que o inicial");
    return;
  }

  if (await conflito(
    dias[i].value,
    inicios[i].value,
    fins[i].value,
    tipo
  )) {
    alert(`Hor√°rio indispon√≠vel: ${dias[i].value} ${inicios[i].value}`);
    return;
  }
}


  // üíæ salva depois de validar tudo
  for (let i = 0; i < dias.length; i++) {
    const alunoSelect = alunoHorario;
    const alunoLogin = alunoSelect.value;
    const alunoNome = alunoSelect.options[alunoSelect.selectedIndex].text;
    await addDoc(collection(db, "horarios"), {
      alunoLogin,
      alunoNome,
      tipo,
      dia: dias[i].value,
      inicio: inicios[i].value,
      fim: fins[i].value,
      criadoEm: new Date()
    });
  }

  alunoHorario.value = "";
  tipoAula.value = "";
  qtdAulas.value = "";
  horariosSemana.innerHTML = "";
  renderHorariosFirestore();
};

/* GERAR CAMPOS */
window.gerarHorarios = function (){
    const qtd = Number(qtdAulas.value);
    horariosSemana.innerHTML = "";

    for(let i = 1; i <= qtd; i++){
        horariosSemana.innerHTML += `
        <div class="card" style="background:#f9fafb">
            <strong>Aula ${i}</strong><br><br>

            <select class="dia">
                <option value="">Dia da semana</option>
                <option>Segunda</option>
                <option>Ter√ßa</option>
                <option>Quarta</option>
                <option>Quinta</option>
                <option>Sexta</option>
            </select>

            <input type="time" class="inicio">
            <input type="time" class="fim">
        </div>`;
    }
};

/* RENDERIZAR */
async function renderHorariosFirestore() {
  listaHorarios.innerHTML = "";

  const snapshot = await getDocs(collection(db, "horarios"));
  if (snapshot.empty) {
    listaHorarios.innerHTML = "<p>Nenhum hor√°rio cadastrado.</p>";
    return;
  }

  const dias = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta"];
  const horas = [];
  for (let h = 8; h <= 20; h++) horas.push(`${String(h).padStart(2,"0")}:00`);

  const aulas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

  // üî• AGRUPA HOR√ÅRIOS (ESSENCIAL PARA TURMAS)
  const grupos = {};
  aulas.forEach(a => {
    const chave = `${a.dia}-${a.inicio}-${a.fim}-${a.tipo}`;
    if (!grupos[chave]) grupos[chave] = [];
    grupos[chave].push(a);
  });

  let html = `<div class="card"><h3>Calend√°rio semanal</h3>`;
  html += `<div class="calendario-grade">`;

  // Cabe√ßalho
  html += `<div></div>`;
  dias.forEach(d => html += `<div class="cabecalho">${d}</div>`);

  // Grade
  horas.forEach(hora => {
    html += `<div class="hora">${hora}</div>`;

    dias.forEach(dia => {
      html += `<div class="celula">`;

      Object.values(grupos).forEach(grupo => {
        const ref = grupo[0];

        const horaAtual = horaParaMinutos(hora);
        const inicio = horaParaMinutos(ref.inicio);
        const fim = horaParaMinutos(ref.fim);

if (
  ref.dia === dia &&
  horaAtual >= inicio &&
  horaAtual < fim
) {
          html += `
            <div class="aula-grade"
              style="background:${
  ref.tipo === "turma"
    ? "#e0e7ff"   // cor fixa para turma
    : corPorAluno(ref.alunoNome)
}"
              onclick="abrirEdicaoHorario(event)"
              data-chave="${ref.dia}-${ref.inicio}-${ref.fim}-${ref.tipo}"
              data-tipo="${ref.tipo}"
              data-dia="${ref.dia}"
              data-inicio="${ref.inicio}"
              data-fim="${ref.fim}"
            >
              <strong>${ref.tipo === "turma" ? "Turma" : ref.alunoNome}</strong>

              ${
                ref.tipo === "turma"
                  ? `<div class="lista-alunos">
                      ${grupo
 .map(g => g.alunoNome ? `
  <span class="aluno-tag"
    onclick="editarHorarioAluno(event, '${g.id}', '${g.alunoNome}')"
  >
    ${g.alunoNome}
  </span>
` : "")
  .join("")}
                    </div>`
                  : ""
              }

              <small>${ref.inicio} - ${ref.fim}</small>
            </div>
          `;
        }
      });

      html += `</div>`;
    });
  });

  html += `</div></div>`;
  listaHorarios.innerHTML = html;
}

window.mostrar = async function(id) {
  document.querySelectorAll('.section').forEach(s => {
    s.classList.remove('active');
  });

  document.getElementById(id).classList.add('active');

  if (id === "pagamentos") {
    await renderBoletosPorAluno();
  }

  if (id === "horarios") {
    await renderHorariosFirestore(); // ‚úÖ ESSENCIAL
  }
};

window.editarHorarioAluno = async function(event, horarioId, nome) {
  event.stopPropagation();

  if (!confirm(`Deseja mudar o hor√°rio de ${nome}?`)) return;

  const novoDia = prompt("Novo dia:");
  const novoInicio = prompt("Novo in√≠cio:");
  const novoFim = prompt("Novo fim:");

  if (!novoDia || !novoInicio || !novoFim) return;

  if (await conflito(novoDia, novoInicio, novoFim, "particular")) {
    alert("Este hor√°rio √© particular e n√£o pode receber alunos de turma.");
    return;
  }

  await updateDoc(doc(db, "horarios", horarioId), {
    dia: novoDia,
    inicio: novoInicio,
    fim: novoFim
  });

  alert("Hor√°rio do aluno atualizado!");
  renderHorariosFirestore();
};



async function preencherSelectHorario() {
  alunoHorario.innerHTML = '<option value="">Selecione o aluno</option>';

  const snapshot = await getDocs(collection(db, "alunos"));

  snapshot.forEach(doc => {
    const a = doc.data();
    alunoHorario.innerHTML += `
      <option value="${a.login}">${a.nome}</option>
    `;
  });
}


async function initDashboard() {
    await renderAlunosFirestore();
     await preencherSelectHorario(); // üëà AQUI
    await renderTarefasFirestore();
    await renderCalendarioFirestore();
    await renderHorariosFirestore();
    await renderBoletosPorAluno();
}



window.excluirAluno = async function (id, nome) {
  const ok = confirm(
    `Deseja excluir o aluno "${nome}"?\n\n` +
    `‚ö†Ô∏è TODOS os hor√°rios e boletos ser√£o apagados.`
  );
  if (!ok) return;

  try {
    // üî• APAGA HOR√ÅRIOS DO ALUNO
const alunoDoc = await getDocs(collection(db, "alunos"));
let loginAluno = "";

alunoDoc.forEach(d => {
  if (d.id === id) {
    loginAluno = d.data().login;
  }
});

const horariosSnap = await getDocs(collection(db, "horarios"));
for (const docSnap of horariosSnap.docs) {
  if (docSnap.data().alunoLogin === loginAluno) {
    await deleteDoc(doc(db, "horarios", docSnap.id));
  }
}

    // üî• APAGA BOLETOS DO ALUNO
    const boletosSnap = await getDocs(collection(db, "boletos"));
    for (const docSnap of boletosSnap.docs) {
      if (docSnap.data().alunoLogin === loginAluno) {
        await deleteDoc(doc(db, "boletos", docSnap.id));
  }
}

    // üî• APAGA ALUNO
    await deleteDoc(doc(db, "alunos", id));

    alert("Aluno e dados vinculados exclu√≠dos!");
    renderAlunosFirestore();
    renderHorariosFirestore();
    renderBoletosPorAluno();

  } catch (e) {
    console.error(e);
    alert("Erro ao excluir aluno");
  }
};

window.editarAluno = function (id, nome, cpf, nivel) {
    alunoEditandoId = id;

    document.getElementById("alunoNome").value = nome;
    document.getElementById("alunoCpf").value = cpf;
    document.getElementById("alunoNivel").value = nivel;
};

window.editarHorario = async function (id, campo, valor) {
  try {
    await updateDoc(doc(db, "horarios", id), {
      [campo]: valor
    });
  } catch (e) {
    console.error(e);
    alert("Erro ao editar hor√°rio");
  }
};

window.excluirHorario = async function (id) {
  const ok = confirm("Excluir este hor√°rio?");
  if (!ok) return;

  try {
    await deleteDoc(doc(db, "horarios", id));
    renderHorariosFirestore();
  } catch (e) {
    console.error(e);
    alert("Erro ao excluir hor√°rio");
  }
};

window.abrirEdicaoHorario = async function(event) {
  const el = event.currentTarget;

  const chave = el.dataset.chave;
  const tipo = el.dataset.tipo;

  const nome = el.innerText.split("\n")[0];

  if (!confirm(`Deseja mudar o hor√°rio de ${nome}?`)) return;

  const novoDia = prompt("Novo dia:");
  const novoInicio = prompt("Novo in√≠cio:");
  const novoFim = prompt("Novo fim:");

  if (!novoDia || !novoInicio || !novoFim) return;

  // üîí NOVO BLOQUEIO
  if (await conflito(novoDia, novoInicio, novoFim, tipo)) {
    alert("Este hor√°rio √© particular e n√£o pode receber uma turma.");
    return;
  }

  const snap = await getDocs(collection(db, "horarios"));

  for (const docSnap of snap.docs) {
    const h = docSnap.data();
    const chaveAtual = `${h.dia}-${h.inicio}-${h.fim}-${h.tipo}`;

    if (chaveAtual === chave) {
      await updateDoc(doc(db, "horarios", docSnap.id), {
        dia: novoDia,
        inicio: novoInicio,
        fim: novoFim
      });
    }
  }

  alert("Hor√°rio atualizado!");
  renderHorariosFirestore();
};



function corPorAluno(nome) {
  const cores = ["#fee2e2", "#dcfce7", "#dbeafe", "#fef3c7", "#ede9fe"];

  if (!nome || typeof nome !== "string") {
    return "#e5e7eb"; // cor neutra de fallback
  }

  let hash = 0;
  for (let i = 0; i < nome.length; i++) {
    hash += nome.charCodeAt(i);
  }

  return cores[hash % cores.length];
}


</script>

</body>
</html>
